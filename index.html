<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <title>WMSA NOTAM VISUALIZER</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.15.1/css/ol.css" type="text/css">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; font-size: 13px; }
        #map { width: 100%; height: 100vh; }
        
        /* PANELS */
        .panel-right, .panel-left {
            position: absolute; top: 10px; z-index: 1000;
            background: white; padding: 12px; box-shadow: 0 0 8px rgba(0,0,0,0.2);
            border-radius: 5px; transition: all 0.3s ease;
            font-size: 13px;
        }
        .panel-right { right: 10px; width: 380px; }
        .panel-left { left: 10px; width: 320px; }
        .panel-right.minimized, .panel-left.minimized { 
            height: 36px; overflow: hidden; padding: 5px 12px; 
        }
        .panel-right.minimized .content, .panel-left.minimized .content { 
            display: none; 
        }
        
        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            margin: -12px -12px 12px -12px; padding: 6px 12px;
            background: #004494; /* darker blue */
            color: white; border-radius: 5px 55 0 0;
            cursor: move;
        }
        .panel-header h3 { 
            margin: 0; font-size: 14px; font-weight: bold;
        }
        input, textarea, button, select { 
            width: 100%; margin: 4px 0; padding: 6px; box-sizing: border-box; 
            font-size: 13px;
        }
        textarea { height: 50px; }
        button { 
            cursor: pointer; background: #004494; color: white; border: none; 
            font-weight: bold; font-size: 13px; padding: 6px;
        }
        button:hover { background: #003377; }
        button.danger { background: #c82333; }
        button.danger:hover { background: #bd2130; }
        button.small { 
            padding: 3px 6px; font-size: 12px; width: auto; 
        }
        
        /* HIGH CONTRAST TOGGLE BUTTON */
        button.panel-toggle {
            padding: 4px 8px;
            font-size: 18px;
            font-weight: bold;
            background: white;
            color: black;
            border: 2px solid black;
            border-radius: 4px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        button.panel-toggle:hover {
            background: #f0f0f0;
        }
        
        /* SCROLLABLE CONTENT */
        .content {
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            padding-right: 4px;
        }
        .content::-webkit-scrollbar {
            width: 8px;
        }
        .content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* SEARCH & EXPORT/IMPORT */
        #searchInput {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 2px solid #004494;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
        }
        #searchInput:focus {
            outline: none;
            border-color: #003377;
            box-shadow: 0 0 5px rgba(0,59,130,0.5);
        }
        
        /* ZONE LIST - COMPACT */
        #zoneListPanel {
            text-transform: uppercase;
        }

        .zone-item {
            padding: 6px; margin: 4px 0; background: #f9f9f9; border-radius: 3px;
            display: flex; flex-direction: column; font-size: 12px;
            border-left: 3px solid transparent;
        }
        .zone-item.highlight {
            border-left: 3px solid #004494;
            background: #e9f7ff;
        }
        .zone-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 3px;
        }
        .color-box {
            width: 12px; height: 12px; margin-right: 6px; display: inline-block;
        }
        .zone-main {
            display: flex; align-items: flex-start; gap: 6px;
            margin-bottom: 3px;
        }
        .zone-desc {
            flex: 1; word-wrap: break-word;
        }
        .toggle-label-icon {
            cursor: pointer; font-size: 16px; color: #555; padding: 2px;
            border-radius: 3px;
        }
        .toggle-label-icon:hover { 
            background: #eee; 
        }
        .edit-icon, .delete-icon {
            background: none; border: none; font-size: 16px; padding: 0; margin: 0; font-weight: bold;
            cursor: pointer;
        }
        .edit-icon { color: #204d74; }
        .delete-icon { color: #c82333; }
        .edit-icon:hover { color: #122b40; }
        .delete-icon:hover { color: #bd2130; }
        
        /* COORD INPUT */
        .coord-inputs {
            margin-top: 10px; padding: 8px; background: #f5f5f5; border-radius: 4px;
        }
        .point-row { display: flex; gap: 5px; margin: 4px 0; }
        .point-row input { width: 48%; }
        .points-preview {
            max-height: 100px; overflow-y: auto; margin: 8px 0; padding: 6px;
            background: #eef; border-radius: 3px; font-size: 11px;
        }
        .point-tag {
            display: inline-block; background: #004494; color: white;
            padding: 1px 4px; margin: 1px 0; border-radius: 2px; font-size: 10px;
        }
        .point-tag button {
            color: white; background: none; border: none; padding: 0 2px;
            cursor: pointer; font-weight: bold; font-size: 10px;
        }
        .status-pending { color: #d39e00; font-weight: bold; font-size: 11px; }
        .status-active { color: #28a745; font-weight: bold; font-size: 11px; }
        .status-expired { color: #c82333; font-weight: bold; font-size: 11px; }
        .error { border: 2px solid #c82333 !important; }

        /* EDIT MODAL */
        #editModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;
        }
        #editModal > div {
            background: white; width: 90%; max-width: 500px; margin: 50px auto; padding: 20px; border-radius: 8px;
        }
        #editModal h3 { margin-top: 0; }
        #editModal button { width: auto; padding: 8px 16px; margin: 5px; }
    </style>
</head>
<body>

<!-- EDIT MODAL -->
<div id="editModal">
    <div>
        <h3>Edit Zone</h3>
        <input type="text" id="editId" placeholder="NOTAM ID" style="width:100%; margin:5px 0; padding:8px; text-transform:uppercase;">
        <textarea id="editDesc" placeholder="Description" style="width:100%; height:60px; margin:5px 0; padding:8px;"></textarea>
        <div style="display:flex; gap:5px;">
            <input type="number" id="editMinAlt" placeholder="Min Alt (ft)" style="width:48%; padding:8px;">
            <input type="number" id="editMaxAlt" placeholder="Max Alt (ft)" style="width:48%; padding:8px;">
        </div>
        <input type="datetime-local" id="editStartTime" style="width:100%; margin:5px 0; padding:8px;">
        <input type="datetime-local" id="editEndTime" style="width:100%; margin:5px 0; padding:8px;">
        
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button id="saveEditBtn" style="flex:1; background:#28a745; color:white; border:none; padding:10px; font-weight:bold;">üíæ Save Changes</button>
            <button id="cancelEditBtn" style="flex:1; background:#c82333; color:white; border:none; padding:10px; font-weight:bold;">‚ùå Cancel</button>
        </div>
    </div>
</div>

<!-- RIGHT PANEL: Create Zones -->
<div class="panel-right" id="controlPanel">
    <div class="panel-header">
        <h3>ü°∫ Create Zone</h3>
        <button id="toggleRightPanelBtn" class="panel-toggle">‚ñº</button>
    </div>
    <div class="content">
        <input type="text" id="zoneId" placeholder="NOTAM SERIES" required style="text-transform:uppercase;">
        <textarea id="zoneDesc" placeholder="DESCRIPTION" required></textarea>
        
        <div style="display:flex; gap:5px;">
            <input type="number" id="minAlt" placeholder="Min Alt (ft)" min="0" style="width:48%;">
            <input type="number" id="maxAlt" placeholder="Max Alt (ft)" min="0" style="width:48%;">
        </div>
        
        <label style="font-size:12px;">‚è∞ Start Time (UTC)</label>
        <input type="datetime-local" id="startTime" placeholder="Start (UTC)">
        
        <label style="font-size:12px;">‚è∞ End Time (UTC)</label>
        <input type="datetime-local" id="endTime" placeholder="End (UTC)">
        
        <button id="addDrawBtn">‚úèÔ∏è Draw Zone</button>
        <button id="openCoordBtn">üìç Add by Coordinates</button>

        <div id="coordSection" style="display:none;" class="coord-inputs">
            <div class="point-row">
                <input type="text" id="pointLat" placeholder="Lat (e.g., 3.137489)" step="any">
                <input type="text" id="pointLng" placeholder="Lng (e.g., 101.526181)" step="any">
                <button id="addPointBtn" class="small">+ Add</button>
            </div>
            <div class="points-preview" id="pointsPreview"></div>
            <div style="margin-top:8px; display:flex; gap:5px;">
                <button id="createPolyBtn" class="small" style="background:#28a745;">‚úÖ Create</button>
                <button id="clearPointsBtn" class="small danger">üóëÔ∏è Clear</button>
            </div>
        </div>

        <hr style="margin:10px 0;">
        <button id="exportBtn">üì§ Export Zones</button>
        <button id="importBtn">üì• Import Zones</button>
        <input type="file" id="importFile" accept=".json" style="display:none;">
    </div>
</div>

<!-- LEFT PANEL: Zone List -->
<div class="panel-left" id="zoneListPanel">
    <div class="panel-header">
        <h3>üìã Zones (0)</h3>
        <button id="toggleLeftPanelBtn" class="panel-toggle">‚ñº</button>
    </div>
    <div class="content">
        <input type="text" id="searchInput" placeholder="üîç Search by ID or Description" autocomplete="off">
        <div id="zoneListContainer">
            <div style="padding:10px; color:#888; font-size:12px;">No active zones</div>
        </div>
    </div>
</div>

<div id="map"></div>

<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.15.1/build/ol.js"></script>
<script>
// =============================
// üó∫Ô∏è MAP ‚Äî ROTATED 240¬∞ CLOCKWISE
// =============================

const center = ol.proj.fromLonLat([101.53, 3.13]);
const rotationRad = (240 * Math.PI) / 180;

const map = new ol.Map({
    target: 'map',
    layers: [
        new ol.layer.Tile({
            source: new ol.source.OSM()
        })
    ],
    view: new ol.View({
        center: center,
        zoom: 12,
        rotation: -rotationRad
    })
});

// =============================
// POPUP HANDLER ‚Äî SHOW ON CLICK, HIDE ELSEWHERE
// =============================

let zones = []; // Declare early for popup handler

map.on('click', function(evt) {
    let found = false;
    for (let i = 0; i < zones.length; i++) {
        const zone = zones[i];
        if (map.forEachFeatureAtPixel(evt.pixel, function(feature) {
            return feature === zone.feature;
        })) {
            zone.popup.setPosition(evt.coordinate);
            found = true;
        } else {
            zone.popup.setPosition(undefined);
        }
    }
    if (!found) {
        zones.forEach(zone => zone.popup.setPosition(undefined));
    }
});

// =============================
// WMSA BOUNDARY
// =============================

const wmsaCoords = [
  [101.5261818612008, 3.137489173426729],
  [101.5369417199503, 3.143636322688836],
  [101.5554116137157, 3.114549926981039],
  [101.5440129586262, 3.106801561707011],
  [101.594961195717, 2.979759953663965],
  [101.6583384772399, 3.017402274699589],
  [101.5727587990802, 3.123805981197957],
  [101.5616469816414, 3.117397632418947],
  [101.5439996209306, 3.147846223647465],
  [101.554999756724, 3.154278182318513],
  [101.5039157532288, 3.281388971902559],
  [101.440162788123, 3.24377920778443],
  [101.5261818612008, 3.137489173426729]
].map(coord => ol.proj.fromLonLat(coord));

const wmsaFeature = new ol.Feature({
    geometry: new ol.geom.Polygon([wmsaCoords])
});

const wmsaLayer = new ol.layer.Vector({
    source: new ol.source.Vector({
        features: [wmsaFeature]
    }),
    style: new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: '#000',
            width: 3,
            lineDash: [8, 4]
        }),
        fill: new ol.style.Fill({
            color: 'rgba(0,0,0,0)'
        })
    })
});

map.addLayer(wmsaLayer);

// =============================
// PANELS
// =============================

const rightPanel = document.getElementById('controlPanel');
const toggleRightBtn = document.getElementById('toggleRightPanelBtn');
let isRightMinimized = false;

toggleRightBtn.addEventListener('click', function() {
    isRightMinimized = !isRightMinimized;
    rightPanel.classList.toggle('minimized');
    toggleRightBtn.textContent = isRightMinimized ? '‚ñ≤' : '‚ñº';
});

const leftPanel = document.getElementById('zoneListPanel');
const toggleLeftBtn = document.getElementById('toggleLeftPanelBtn');
let isLeftMinimized = false;

toggleLeftBtn.addEventListener('click', function() {
    isLeftMinimized = !isLeftMinimized;
    leftPanel.classList.toggle('minimized');
    toggleLeftBtn.textContent = isLeftMinimized ? '‚ñ≤' : '‚ñº';
});

// =============================
// SEARCH FUNCTIONALITY
// =============================

const searchInput = document.getElementById('searchInput');
const zoneListContainer = document.getElementById('zoneListContainer');

searchInput.addEventListener('input', function() {
    const term = this.value.toLowerCase().trim();
    updateZoneList(term);
});

function highlightZoneOnMap(index) {
    if (index >= 0 && index < zones.length) {
        const zone = zones[index];
        const extent = zone.feature.getGeometry().getExtent();
        map.getView().fit(extent, { padding: [50, 50, 50, 50] });
        
        document.querySelectorAll('.zone-item').forEach(el => el.classList.remove('highlight'));
        const item = document.querySelector(`.zone-item[data-index="${index}"]`);
        if (item) item.classList.add('highlight');
    }
}

// =============================
// COORDINATE INPUT
// =============================

let manualPoints = [];
const coordSection = document.getElementById('coordSection');
const pointsPreview = document.getElementById('pointsPreview');

function validateCoordinate(value, type) {
    const num = parseFloat(value);
    if (isNaN(num)) {
        alert(`Invalid ${type}: "${value}"`);
        return null;
    }
    return num;
}

document.getElementById('openCoordBtn').addEventListener('click', function() {
    coordSection.style.display = coordSection.style.display === 'none' ? 'block' : 'none';
});

document.getElementById('addPointBtn').addEventListener('click', function() {
    const latInput = document.getElementById('pointLat');
    const lngInput = document.getElementById('pointLng');
    latInput.classList.remove('error');
    lngInput.classList.remove('error');

    const lat = validateCoordinate(latInput.value, 'latitude');
    const lng = validateCoordinate(lngInput.value, 'longitude');

    if (lat === null || lng === null) {
        if (lat === null) latInput.classList.add('error');
        if (lng === null) lngInput.classList.add('error');
        return;
    }

    manualPoints.push([lng, lat]);
    updatePointsPreview();
    latInput.value = '';
    lngInput.value = '';
    latInput.focus();
});

document.getElementById('clearPointsBtn').addEventListener('click', function() {
    manualPoints = [];
    updatePointsPreview();
});

function updatePointsPreview() {
    pointsPreview.innerHTML = '';
    if (manualPoints.length === 0) {
        pointsPreview.innerHTML = '<div style="color:#888; font-style:italic; font-size:11px;">No points</div>';
        return;
    }

    manualPoints.forEach((point, index) => {
        const tag = document.createElement('div');
        tag.className = 'point-tag';
        tag.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin:1px 0;';
        tag.innerHTML = `
            <span style="flex:1;">${index+1}: ${point[1].toFixed(5)}, ${point[0].toFixed(5)}</span>
            <button type="button" onclick="removePoint(${index})" style="background:#c82333; color:white; border:none; border-radius:50%; width:16px; height:16px; font-size:10px; line-height:14px;">√ó</button>
        `;
        pointsPreview.appendChild(tag);
    });
}

function removePoint(index) {
    manualPoints.splice(index, 1);
    updatePointsPreview();
}

// Create polygon from manual points
document.getElementById('createPolyBtn').addEventListener('click', function() {
    if (manualPoints.length < 3) {
        alert('Please add at least 3 points to create a polygon.');
        return;
    }

    const zoneId = document.getElementById('zoneId').value.trim();
    const zoneDesc = document.getElementById('zoneDesc').value.trim();
    const minAlt = document.getElementById('minAlt').value ? parseInt(document.getElementById('minAlt').value) : null;
    const maxAlt = document.getElementById('maxAlt').value ? parseInt(document.getElementById('maxAlt').value) : null;
    const startTime = document.getElementById('startTime').value ? new Date(document.getElementById('startTime').value).toISOString() : null;
    const endTime = document.getElementById('endTime').value ? new Date(document.getElementById('endTime').value).toISOString() : null;

    if (!zoneId) {
        alert('Please enter Zone ID.');
        return;
    }

    // Ensure ring is closed [lon, lat]
    const ringLonLat = manualPoints.slice();
    const first = ringLonLat[0];
    const last = ringLonLat[ringLonLat.length - 1];
    if (first[0] !== last[0] || first[1] !== last[1]) {
        ringLonLat.push(first);
    }

    // Project to map coords
    const projected = ringLonLat.map(pt => ol.proj.fromLonLat(pt));

    // Create feature and add as a zone
    const feature = new ol.Feature({
        geometry: new ol.geom.Polygon([projected])
    });

    const color = generateColor(zones.length);
    feature.setStyle(createStyle(color));

    createZoneFromFeature(
        feature,
        zoneId,
        zoneDesc,
        minAlt,
        maxAlt,
        startTime,
        endTime,
        color,
        false // showLabel initially off
    );

    // Reset UI
    manualPoints = [];
    updatePointsPreview();
    coordSection.style.display = 'none';
});

// =============================
// DRAW INTERACTION
// =============================

let drawInteraction = null;

document.getElementById('addDrawBtn').addEventListener('click', function() {
    const zoneId = document.getElementById('zoneId').value.trim();
    const zoneDesc = document.getElementById('zoneDesc').value.trim();
    const minAlt = document.getElementById('minAlt').value ? parseInt(document.getElementById('minAlt').value) : null;
    const maxAlt = document.getElementById('maxAlt').value ? parseInt(document.getElementById('maxAlt').value) : null;
    const startTime = document.getElementById('startTime').value ? new Date(document.getElementById('startTime').value).toISOString() : null;
    const endTime = document.getElementById('endTime').value ? new Date(document.getElementById('endTime').value).toISOString() : null;

    if (!zoneId) {
        alert("Please enter Zone ID.");
        return;
    }

    if (drawInteraction) map.removeInteraction(drawInteraction);

    drawInteraction = new ol.interaction.Draw({
        source: new ol.source.Vector(),
        type: 'Polygon'
    });

    map.addInteraction(drawInteraction);

    drawInteraction.on('drawend', function(event) {
        map.removeInteraction(drawInteraction);
        drawInteraction = null;

        const feature = event.feature;
        const color = generateColor(zones.length);
        
        feature.setStyle(createStyle(color));
        createZoneFromFeature(feature, zoneId, zoneDesc, minAlt, maxAlt, startTime, endTime, color, false);
    });
});

// =============================
// DARKER COLORS FOR ATC
// =============================

const COLORS = [
    '#8B0000', // Dark Red
    '#006400', // Dark Green
    '#8B8B00', // Dark Yellow
    '#00008B', // Dark Blue
    '#8B4513', // SaddleBrown
    '#4B0082', // Indigo
    '#008B8B', // Dark Cyan
    '#8B008B', // Dark Magenta
    '#2F4F4F', // Dark Slate Gray
    '#556B2F'  // Dark Olive Green
];

function generateColor(index) {
    return COLORS[index % COLORS.length];
}

function createStyle(color) {
    return new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: color,
            width: 2
        }),
        fill: new ol.style.Fill({
            color: color + '66' // 40% opacity
        })
    });
}

// =============================
// ZONE SYSTEM ‚Äî WITH POPUP
// =============================

function createZoneFromFeature(feature, zoneId, zoneDesc, minAlt, maxAlt, startTime, endTime, color, showLabel) {
    const source = new ol.source.Vector({
        features: [feature]
    });
    
    const layer = new ol.layer.Vector({
        source: source
    });
    
    map.addLayer(layer);

    // ‚úÖ POPUP OVERLAY ‚Äî ONLY ID + ALTITUDE
    const popup = new ol.Overlay({
        element: document.createElement('div'),
        positioning: 'bottom-center',
        stopEvent: false
    });
    map.addOverlay(popup);

    const altStr = minAlt || maxAlt ? `${minAlt || 0}‚Äì${maxAlt || 'UNL'} ft` : 'No altitude';
    popup.getElement().innerHTML = `
        <div style="
            background: #FFFFFF;
            color: #000000;
            padding: 8px 12px;
            border: 2px solid #000000;
            border-radius: 6px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            line-height: 1.4;
        ">
            <strong>${zoneId}</strong><br>
            <small>Alt: ${altStr}</small>
        </div>
    `;

    const zone = {
        id: zoneId,
        desc: zoneDesc,
        minAlt: minAlt,
        maxAlt: maxAlt,
        startTime: startTime,
        endTime: endTime,
        layer: layer,
        feature: feature,
        color: color,
        popup: popup,
        showLabel: showLabel,
        label: null
    };

    zones.push(zone);
    if (showLabel) setTimeout(() => toggleZoneLabel(zones.length - 1), 100);
    updateZoneList();
    saveZonesToStorage();

    if (startTime || endTime) {
        setTimeout(() => updateAllStatuses(), 1000);
    }
}

// =============================
// EXPORT / IMPORT ‚Äî WITH MANDATORY SAVE
// =============================

// Export
document.getElementById('exportBtn').addEventListener('click', function() {
    if (zones.length === 0) {
        alert("No zones to export.");
        return;
    }

    const data = zones.map(z => {
        const geom = z.feature.getGeometry();
        const coords = geom.getType() === 'Polygon' ? 
            geom.getCoordinates()[0].map(pt => ol.proj.toLonLat(pt)) : [];
        return {
            id: z.id,
            desc: z.desc,
            minAlt: z.minAlt,
            maxAlt: z.maxAlt,
            startTime: z.startTime,
            endTime: z.endTime,
            color: z.color,
            showLabel: z.showLabel,
            geometry: {
                type: 'Polygon',
                coordinates: coords
            }
        };
    });

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `wmsa_notams_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
});

// Import ‚Äî ALWAYS replace + save
document.getElementById('importBtn').addEventListener('click', function() {
    document.getElementById('importFile').click();
});

document.getElementById('importFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(ev) {
        try {
            const data = JSON.parse(ev.target.result);
            
            // REPLACE ALL
            zones.forEach(z => {
                map.removeLayer(z.layer);
                if (z.popup) map.removeOverlay(z.popup);
                if (z.label) map.removeOverlay(z.label);
            });
            zones = [];

            data.forEach(item => {
                if (!item.geometry?.coordinates || item.geometry.coordinates.length < 3) return;
                
                const projectedCoords = item.geometry.coordinates.map(pt => ol.proj.fromLonLat(pt));
                const feature = new ol.Feature({
                    geometry: new ol.geom.Polygon([projectedCoords])
                });

                const layer = new ol.layer.Vector({
                    source: new ol.source.Vector({ features: [feature] })
                });

                feature.setStyle(createStyle(item.color));
                map.addLayer(layer);

                // Create popup
                const popup = new ol.Overlay({
                    element: document.createElement('div'),
                    positioning: 'bottom-center',
                    stopEvent: false
                });
                map.addOverlay(popup);

                const altStr = item.minAlt || item.maxAlt ? `${item.minAlt || 0}‚Äì${item.maxAlt || 'UNL'} ft` : 'No altitude';
                popup.getElement().innerHTML = `
                    <div style="
                        background: #FFFFFF;
                        color: #000000;
                        padding: 8px 12px;
                        border: 2px solid #000000;
                        border-radius: 6px;
                        font-family: Arial, sans-serif;
                        font-size: 13px;
                        font-weight: bold;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.5);
                        line-height: 1.4;
                    ">
                        <strong>${item.id}</strong><br>
                        <small>Alt: ${altStr}</small>
                    </div>
                `;

                const zone = {
                    id: item.id,
                    desc: item.desc,
                    minAlt: item.minAlt,
                    maxAlt: item.maxAlt,
                    startTime: item.startTime,
                    endTime: item.endTime,
                    layer: layer,
                    feature: feature,
                    color: item.color,
                    popup: popup,
                    showLabel: item.showLabel,
                    label: null
                };

                zones.push(zone);
            });

            setTimeout(() => {
                zones.forEach((zone, index) => {
                    if (zone.showLabel) toggleZoneLabel(index);
                });
            }, 500);

            updateZoneList();
            saveZonesToStorage();
            alert(`‚úÖ Imported ${data.length} zones. Data saved locally.`);
        } catch (error) {
            console.error("Import failed:", error);
            alert("‚ùå Failed to import zones: " + error.message);
        }
    };
    reader.readAsText(file);
    this.value = '';
});

// =============================
// EDIT ZONE
// =============================

let currentEditIndex = -1;

function editZone(index) {
    if (index < 0 || index >= zones.length) return;
    
    const zone = zones[index];
    currentEditIndex = index;
    
    document.getElementById('editId').value = zone.id;
    document.getElementById('editDesc').value = zone.desc;
    document.getElementById('editMinAlt').value = zone.minAlt || '';
    document.getElementById('editMaxAlt').value = zone.maxAlt || '';
    document.getElementById('editStartTime').value = zone.startTime ? new Date(zone.startTime).toISOString().slice(0,16) : '';
    document.getElementById('editEndTime').value = zone.endTime ? new Date(zone.endTime).toISOString().slice(0,16) : '';
    
    document.getElementById('editModal').style.display = 'block';
}

document.getElementById('saveEditBtn').addEventListener('click', function() {
    if (currentEditIndex < 0) return;
    
    const zone = zones[currentEditIndex];
    zone.id = document.getElementById('editId').value.trim() || zone.id;
    zone.desc = document.getElementById('editDesc').value.trim() || zone.desc;
    zone.minAlt = document.getElementById('editMinAlt').value ? parseInt(document.getElementById('editMinAlt').value) : null;
    zone.maxAlt = document.getElementById('editMaxAlt').value ? parseInt(document.getElementById('editMaxAlt').value) : null;
    zone.startTime = document.getElementById('editStartTime').value ? new Date(document.getElementById('editStartTime').value).toISOString() : null;
    zone.endTime = document.getElementById('editEndTime').value ? new Date(document.getElementById('editEndTime').value).toISOString() : null;
    
    // Update popup
    const altStr = zone.minAlt || zone.maxAlt ? `${zone.minAlt || 0}‚Äì${zone.maxAlt || 'UNL'} ft` : 'No altitude';
    zone.popup.getElement().innerHTML = `
        <div style="
            background: #FFFFFF;
            color: #000000;
            padding: 8px 12px;
            border: 2px solid #000000;
            border-radius: 6px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            line-height: 1.4;
        ">
            <strong>${zone.id}</strong><br>
            <small>Alt: ${altStr}</small>
        </div>
    `;
    
    if (zone.showLabel) {
        toggleZoneLabel(currentEditIndex);
    }
    
    updateZoneList();
    saveZonesToStorage();
    document.getElementById('editModal').style.display = 'none';
});

document.getElementById('cancelEditBtn').addEventListener('click', function() {
    document.getElementById('editModal').style.display = 'none';
});

// =============================
// DELETE ZONE
// =============================

function confirmDeleteZone(index) {
    if (index >= 0 && index < zones.length) {
        const zoneId = zones[index].id;
        if (confirm(`Delete zone "${zoneId}"?`)) {
            deleteZone(index);
        }
    }
}

function deleteZone(index) {
    if (index >= 0 && index < zones.length) {
        const zone = zones[index];
        map.removeLayer(zone.layer);
        if (zone.popup) map.removeOverlay(zone.popup);
        if (zone.label) map.removeOverlay(zone.label);
        zones.splice(index, 1);
        updateZoneList();
        saveZonesToStorage();
    }
}

// =============================
// TOGGLE LABEL ‚Äî HIGH CONTRAST + TEXT WRAP
// =============================

function toggleZoneLabel(index) {
    if (index >= 0 && index < zones.length) {
        const zone = zones[index];
        if (zone.showLabel) {
            if (zone.label) map.removeOverlay(zone.label);
            zone.label = null;
        } else {
            const geom = zone.feature.getGeometry();
            const center = geom.getType() === 'Polygon' ? 
                geom.getInteriorPoint().getCoordinates() : 
                geom.getExtent();
            if (!Array.isArray(center)) {
                center = [(geom[0] + geom[2])/2, (geom[1] + geom[3])/2];
            }

            const status = getZoneStatus(zone.startTime, zone.endTime);
            const statusPrefix = status === 'pending' ? '[PENDING] ' : status === 'expired' ? '[EXPIRED] ' : '[ACTIVE] ';
            const altStr = zone.minAlt || zone.maxAlt ? `(${zone.minAlt || 0}‚Äì${zone.maxAlt || 'UNL'} ft)` : '';
            const labelStr = `${statusPrefix}${zone.id} ${zone.desc} ${altStr}`;

            const labelElement = document.createElement('div');
            labelElement.innerHTML = `
                <div style="
                    background: #FFFFFF;
                    color: #000000;
                    padding: 4px 6px;
                    border: 2px solid #000000;
                    border-radius: 4px;
                    font-size: 10px;
                    font-weight: bold;
                    text-align: center;
                    word-wrap: break-word;
                    max-width: 200px;
                    line-height: 1.3;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
                ">${labelStr}</div>`;

            const label = new ol.Overlay({
                position: center,
                positioning: 'center-center',
                element: labelElement,
                stopEvent: false
            });

            map.addOverlay(label);
            zone.label = label;
        }
        zone.showLabel = !zone.showLabel;
        saveZonesToStorage();
    }
}

// =============================
// ZONE LIST ‚Äî WITH SEARCH & EDIT
// =============================

function updateZoneList(filterTerm = '') {
    const container = document.getElementById('zoneListContainer');
    const header = leftPanel.querySelector('h3');
    header.textContent = `üìã Zones (${zones.length})`;

    container.innerHTML = '';

    if (zones.length === 0) {
        container.innerHTML = '<div style="padding:10px; color:#888; font-size:12px;">No active zones</div>';
        return;
    }

    const filteredZones = filterTerm 
        ? zones.filter(z => 
            z.id.toLowerCase().includes(filterTerm) || 
            z.desc.toLowerCase().includes(filterTerm)
          )
        : zones;

    if (filteredZones.length === 0 && filterTerm) {
        container.innerHTML = '<div style="padding:10px; color:#888; font-size:12px;">No matching zones</div>';
        return;
    }

    filteredZones.forEach((zone, index) => {
        const originalIndex = zones.indexOf(zone);
        const altStr = zone.minAlt || zone.maxAlt ? `(${zone.minAlt || 0}‚Äì${zone.maxAlt || 'UNL'} ft)` : '';
        const status = formatStatus(zone.startTime, zone.endTime).replace(/<[^>]*>/g, '');

        const item = document.createElement('div');
        item.className = 'zone-item';
        item.setAttribute('data-index', originalIndex);
        item.innerHTML = `
            <div class="zone-header">
                <div style="display:flex; align-items:center;">
                    <div class="color-box" style="background:${zone.color};"></div>
                    <strong>${zone.id}</strong>
                </div>
                <div class="zone-actions">
                    <button class="edit-icon" onclick="editZone(${originalIndex})">‚úé</button>
                    <button class="delete-icon" onclick="confirmDeleteZone(${originalIndex})">√ó</button>
                </div>
            </div>
            <div class="zone-main" style="align-items: flex-start;">
                <div class="zone-desc" style="flex:1; word-wrap: break-word;">${zone.desc} ${altStr}</div>
                <div class="toggle-label-icon" onclick="toggleZoneLabel(${originalIndex})" title="Toggle label">
                    <span style="
                        display: inline-block;
                        background: white;
                        color: black;
                        border: 2px solid black;
                        border-radius: 4px;
                        padding: 2px 6px;
                        font-size: 16px;
                        font-weight: bold;
                        line-height: 1;
                        text-align: center;
                    ">${zone.showLabel ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}</span>
                </div>
            </div>
            <div><small class="zone-status">${status}</small></div>
        `;
        
        item.addEventListener('click', function(e) {
            if (!e.target.closest('.edit-icon') && !e.target.closest('.delete-icon') && !e.target.closest('.toggle-label-icon')) {
                highlightZoneOnMap(originalIndex);
            }
        });
        
        container.appendChild(item);
    });
}

// =============================
// TIME & STATUS
// =============================

function formatDuration(ms) {
    if (ms < 0) ms = -ms;
    const d = Math.floor(ms / 86400000);
    const h = Math.floor((ms % 86400000) / 3600000);
    const m = Math.floor((ms % 3600000) / 60000);
    return `${d}d ${h}h ${m}m`;
}

function getZoneStatus(start, end) {
    const now = new Date();
    if (start && now < new Date(start)) return 'pending';
    if (end && now > new Date(end)) return 'expired';
    return 'active';
}

function formatStatus(start, end) {
    const now = new Date();
    const s = getZoneStatus(start, end);
    if (s === 'pending' && start) return `<span class="status-pending">üü© +${formatDuration(new Date(start) - now)}</span>`;
    if (s === 'active' && end) return `<span class="status-active">üü® ${formatDuration(new Date(end) - now)}</span>`;
    if (s === 'expired' && end) return `<span class="status-expired">üü• -${formatDuration(now - new Date(end))}</span>`;
    return "<span style='color:#888; font-size:11px;'>üïí No time</span>";
}

function updateAllStatuses() {
    zones.forEach((zone, index) => {
        if (zone.label && zone.showLabel) {
            toggleZoneLabel(index);
        }
    });
    setTimeout(updateAllStatuses, 60000);
}

// =============================
// MANDATORY PERSISTENCE
// =============================

function saveZonesToStorage() {
    const data = zones.map(z => {
        const geom = z.feature.getGeometry();
        const coords = geom.getType() === 'Polygon' ? 
            geom.getCoordinates()[0].map(pt => ol.proj.toLonLat(pt)) : [];
        return {
            id: z.id,
            desc: z.desc,
            minAlt: z.minAlt,
            maxAlt: z.maxAlt,
            startTime: z.startTime,
            endTime: z.endTime,
            color: z.color,
            showLabel: z.showLabel,
            geometry: {
                type: 'Polygon',
                coordinates: coords
            }
        };
    });
    localStorage.setItem('wmsaZones', JSON.stringify(data));
}

// ‚úÖ LOAD ZONES FROM notams.json ON GITHUB
async function loadZonesFromGitHub() {
    try {
        // Add cache-busting to avoid stale data
        const response = await fetch('notams.json?' + Date.now());
        if (!response.ok) throw new Error("Failed to load notams.json");
        
        const data = await response.json();
        zones = []; // clear existing

        // Remove all current layers
        map.getLayers().getArray()
            .filter(layer => layer !== wmsaLayer && layer !== map.getLayers().item(0))
            .forEach(layer => map.removeLayer(layer));

        data.forEach(item => {
            if (!item.geometry?.coordinates || item.geometry.coordinates.length < 3) return;
            
            const projectedCoords = item.geometry.coordinates.map(pt => ol.proj.fromLonLat(pt));
            const feature = new ol.Feature({
                geometry: new ol.geom.Polygon([projectedCoords])
            });

            const layer = new ol.layer.Vector({
                source: new ol.source.Vector({ features: [feature] })
            });

            feature.setStyle(createStyle(item.color));
            map.addLayer(layer);

            // Create popup
            const popup = new ol.Overlay({
                element: document.createElement('div'),
                positioning: 'bottom-center',
                stopEvent: false
            });
            map.addOverlay(popup);

            const altStr = item.minAlt || item.maxAlt ? `${item.minAlt || 0}‚Äì${item.maxAlt || 'UNL'} ft` : 'No altitude';
            popup.getElement().innerHTML = `
                <div style="
                    background: #FFFFFF;
                    color: #000000;
                    padding: 8px 12px;
                    border: 2px solid #000000;
                    border-radius: 6px;
                    font-family: Arial, sans-serif;
                    font-size: 13px;
                    font-weight: bold;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
                    line-height: 1.4;
                ">
                    <strong>${item.id}</strong><br>
                    <small>Alt: ${altStr}</small>
                </div>
            `;

            const zone = {
                id: item.id,
                desc: item.desc,
                minAlt: item.minAlt,
                maxAlt: item.maxAlt,
                startTime: item.startTime,
                endTime: item.endTime,
                layer: layer,
                feature: feature,
                color: item.color,
                popup: popup,
                showLabel: item.showLabel,
                label: null
            };

            zones.push(zone);

            if (item.showLabel) {
                setTimeout(() => toggleZoneLabel(zones.length - 1), 100);
            }
        });

        updateZoneList();
        if (zones.some(z => z.startTime || z.endTime)) {
            setTimeout(updateAllStatuses, 1000);
        }

    } catch (error) {
        console.error("Failed to load zones:", error);
        alert("‚ö†Ô∏è Could not load NOTAM data. Check browser console (F12).");
    }
}

// INIT
loadZonesFromGitHub();

</script>

</body>

</html>
